{
  "version": 3,
  "sources": ["../../../../Documents/5starsupport-api/netlify/functions/auth-login.js"],
  "sourceRoot": "C:/Users/jeffr/AppData/Local/Temp/tmp-81060-PiePHb2ObNEE",
  "sourcesContent": ["// netlify/functions/auth-login.js\nconst crypto = require(\"node:crypto\");\n\nfunction json(statusCode, data, headers = {}) {\n  return {\n    statusCode,\n    headers: {\n      \"content-type\": \"application/json; charset=utf-8\",\n      ...headers,\n    },\n    body: JSON.stringify(data),\n  };\n}\n\nfunction buildCorsHeaders(origin) {\n  const allowed = (process.env.ALLOWED_ORIGINS || \"\")\n    .split(\",\")\n    .map((s) => s.trim())\n    .filter(Boolean);\n\n  // If ALLOWED_ORIGINS is empty -> allow all (or lock it down if you prefer)\n  const allowOrigin = allowed.length === 0 ? \"*\" : allowed.includes(origin) ? origin : \"\";\n\n  return {\n    \"access-control-allow-origin\": allowOrigin,\n    \"access-control-allow-methods\": \"POST,OPTIONS\",\n    \"access-control-allow-headers\": \"content-type,authorization\",\n    \"access-control-max-age\": \"86400\",\n    ...(allowOrigin && allowOrigin !== \"*\" ? { vary: \"origin\" } : {}),\n  };\n}\n\nfunction b64url(str) {\n  return Buffer.from(str, \"utf8\")\n    .toString(\"base64\")\n    .replace(/=/g, \"\")\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\");\n}\n\nfunction hmacSha256(secret, data) {\n  return crypto\n    .createHmac(\"sha256\", secret)\n    .update(data)\n    .digest(\"base64\")\n    .replace(/=/g, \"\")\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\");\n}\n\nfunction signJwt(secret, payload) {\n  const header = { alg: \"HS256\", typ: \"JWT\" };\n  const data = `${b64url(JSON.stringify(header))}.${b64url(JSON.stringify(payload))}`;\n  const sig = hmacSha256(secret, data);\n  return `${data}.${sig}`;\n}\n\nfunction timingSafeEqualStr(a, b) {\n  const ba = Buffer.from(a);\n  const bb = Buffer.from(b);\n  if (ba.length !== bb.length) return false;\n  return crypto.timingSafeEqual(ba, bb);\n}\n\nfunction sha256Hex(s) {\n  return crypto.createHash(\"sha256\").update(s).digest(\"hex\");\n}\n\nexports.handler = async (event) => {\n  const origin = event.headers?.origin || \"\";\n  const cors = buildCorsHeaders(origin);\n\n  if (event.httpMethod === \"OPTIONS\") {\n    return { statusCode: 204, headers: cors, body: \"\" };\n  }\n\n  if (event.httpMethod !== \"POST\") {\n    return json(405, { error: \"method_not_allowed\" }, cors);\n  }\n\n  const jwtSecret = process.env.JWT_SECRET || \"\";\n  if (!jwtSecret) {\n    return json(500, { error: \"missing_jwt_secret\" }, cors);\n  }\n\n  let body = null;\n  try {\n    body = event.body ? JSON.parse(event.body) : null;\n  } catch {\n    body = null;\n  }\n\n  const username = typeof body?.username === \"string\" ? body.username.trim() : \"\";\n  const password = typeof body?.password === \"string\" ? body.password : \"\";\n\n  if (!username || !password) {\n    return json(400, { error: \"missing_credentials\" }, cors);\n  }\n\n  const expectedUser = process.env.CRM_USERNAME || \"\";\n  const expectedPass = process.env.CRM_PASSWORD || \"\";\n  const expectedHash = (process.env.CRM_PASSWORD_HASH || \"\").toLowerCase();\n\n  let ok = false;\n\n  if (expectedUser && username === expectedUser) {\n    if (expectedHash) {\n      ok = timingSafeEqualStr(sha256Hex(password).toLowerCase(), expectedHash);\n    } else if (expectedPass) {\n      ok = timingSafeEqualStr(password, expectedPass);\n    }\n  }\n\n  if (!ok) {\n    return json(401, { error: \"invalid_credentials\" }, cors);\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  const token = signJwt(jwtSecret, {\n    sub: username,\n    role: \"admin\",\n    iat: now,\n    exp: now + 60 * 60 * 12,\n  });\n\n  return json(200, { token, role: \"admin\" }, cors);\n};\n"],
  "mappings": "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",
  "names": []
}
